<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Photo</title>
    <style>
        *{margin: 0;overflow: hidden}
    </style>

    <script src="https://cdn.apple-livephotoskit.com/lpk/1/livephotoskit.js"></script>
</head>
<body>
    <!--<div data-live-photo id="video"-->
        <!--data-photo-src="images/IMG_3603.JPG"-->
        <!--data-video-src="images/IMG_3603.MOV"-->
        <!--style="width: 320px; height: 320px; display: none;">-->
    <!--</div>-->
    <video  id="video" autoplay style="display: none">
        <source src="images/IMG_0033.MOV">
    </video>
    <!--<canvas id="img"></canvas>-->
    <canvas id="canvas"></canvas>
    <!--<div id="my-live-photo-target-element" style="width: 320px; height: 320px;"></div>-->
    <script src="js/three.js"></script>
    <!--<script src="js/firstPersonControl.js"></script>-->
    <!--<script src="js/stats.min.js"></script>-->
    <script src="js/Photo.js"></script>

    <script>
        let video, texture, camera, scene, renderer, canvas = document.getElementById('canvas'),
                parameters, geometry, material, mesh, controls;
        let width = window.innerWidth, height = window.innerHeight;
        let clock = new THREE.Clock(); //第一人称控制需要

        let counter = 0;
        let showUp , meshes = [];

        let container = new THREE.Mesh(new THREE.Geometry(), new THREE.MeshLambertMaterial({transparent:true,opacity:0}))
        init();
//        const player = LivePhotosKit.Player(document.getElementById('my-live-photo-target-element'));
//        player.photoSrc = 'images/IMG_3603.JPG';
//        player.videoSrc = 'images/IMG_3603.MOV';
//        player.addEventListener('photoload', function(evt){
//            console.log('player ready', evt)
//            init()
//        });

        function init() {
            canvas.width = width;
            canvas.height = height;

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera( 50, width / width, 1, 10000 );
            camera.position.z = 0;
            camera.position.y = 0;
            camera.lookAt(new THREE.Vector3(0,0,0))

            var light = new THREE.DirectionalLight( 0xffffff );
            light.position.set( 0.5, 1, 1 ).normalize();
//            scene.add( light );
            light = new THREE.AmbientLight( 0xffffff ); // soft white light
            scene.add( light );

            renderer = new THREE.WebGLRenderer( { canvas: canvas } );
            renderer.setClearColor(0x000000)

          for(let i =0;i<30;i++){
            let cont = new THREE.Photo({
              photoURL : 'images/IMG_0033.JPG',
              videoURL : 'images/IMG_0033.MOV',
              width:400 , height:300, depth:50, xGrid:10, yGrid:10
            })
            setRandomPosition(cont, 1000);
            cont.lookAt(camera.position)
            meshes.push(cont)
            scene.add(cont)
          }


//            controls = new THREE.FirstPersonControls( camera )
//            controls.lookSpeed = .1
//            controls.lookVertical = true
//            controls.lat =90
//            controls.movementSpeed = 100
//            controls.target = cont.position.clone()
//            controls.target.set(0,-1000,-1000)
//            controls.addEventListener( 'change', updateControls );
//            stats = new Stats();
//            document.body.appendChild( stats.dom );

            renderer.render(scene,camera)

            loop()
        }

        function loop() {
//            controls.update(clock.getDelta());
            let smallCamera = camera.clone();
            smallCamera.fov = 20;
            smallCamera.updateProjectionMatrix();
            for(let i =0;i<meshes.length;i++){
              let cont = meshes[i];
              showUp = cont.position.clone().project(smallCamera)
              let shouldShow = (showUp.x < 1 && showUp.x > -1 && showUp.y < 1 && showUp.y > -1 && showUp.z < 1 && showUp.z > -1)

              if(shouldShow ){
                cont.show()
              }
              if(!cont.counter){
                cont.play()
              }
              if( !shouldShow ){
                cont.hide()
              }
            }

//            stats.update();
            renderer.render(scene,camera)
            window.requestAnimationFrame(loop);
        }
        function updateControls()
        {
          renderer.render(scene,camera)
        }

        function setRandomPosition(mesh, distance) {
            let ang1 = Math.PI * Math.random() * 2,
                ang2 = Math.PI * Math.random() * 2,
                dist = Math.cos(ang1) * distance;
            mesh.position.y = Math.sin(ang1) * distance;
            mesh.position.x = Math.cos(ang2) * dist;
            mesh.position.z = Math.sin(ang2) * dist;
        }
    </script>
</body>
</html>